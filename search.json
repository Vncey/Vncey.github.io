[{"title":"RocketMQ Installation - WSL2/UBUNTU","path":"/2023/01/26/WSL2-UBUNTU/","content":"##### Specs and requirement\n``` bash\nwsl version :  WSL2\nrocketmq version : release 5.0.0\nlink: https://github.com/apache/rocketmq/archive/refs/tags/rocketmq-all-5.0.0.tar.gz\njava version : openjdk-8-amd64\n``` \n--------------------------------------------------------------------------------------\n##### Install Java & setup path\n``` bash\n>sudo apt install openjdk-8-jdk\n>java -version\n    openjdk version \"1.8.0_352\"\n    OpenJDK Runtime Environment (build 1.8.0_352-8u352-ga-1~20.04-b08)\n    OpenJDK 64-Bit Server VM (build 25.352-b08, mixed mode)\n>nano ~/.bash_profile\n    add following line to file:\n    export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64\n    export ROCKETMQ_HOME=/opt/rocketmq-rocketmq-all-5.0.0/distribution/target/rocketmq-5.0.0/rocketmq-5.0.0\n    export PATH=$ROCKETMQ_HOME/bin:$PATH\n>source ~/.bash_profile ## to refresh latest update.\n```\n##### To check path\n``` bash\n>echo $ROCKETMQ_HOME   \n    /opt/rocketmq-rocketmq-all-5.0.0/distribution/target/rocketmq-5.0.0/rocketmq-5.0.0\n>echo $JAVA_HOME\n    /usr/lib/jvm/java-8-openjdk-amd64\n ```\n\n``` bash\n> cd /opt\n> wget https://github.com/apache/rocketmq/archive/refs/tags/rocketmq-all-5.0.0.tar.gz\n> cd /opt/rocketmq-rocketmq-all-5.0.0/\n> mvn -Prelease-all -DskipTests clean install -U\n```\n##### Build complete - ready for next step.\n``` bash\n[INFO] Installing /opt/rocketmq-rocketmq-all-5.0.0/distribution/target/rocketmq-5.0.0.zip to /home/vincey/.m2/repository/org/apache/rocketmq/rocketmq-distribution/5.0.0/rocketmq-distribution-5.0.0.zip\n[INFO] ------------------------------------------------------------------------\n[INFO] Reactor Summary for Apache RocketMQ 5.0.0 5.0.0:\n[INFO]\n[INFO] Apache RocketMQ 5.0.0 .............................. SUCCESS [01:09 min]\n[INFO] rocketmq-logging 5.0.0 ............................. SUCCESS [ 34.802 s]\n[INFO] rocketmq-remoting 5.0.0 ............................ SUCCESS [ 45.342 s]\n[INFO] rocketmq-common 5.0.0 .............................. SUCCESS [ 53.854 s]\n[INFO] rocketmq-client 5.0.0 .............................. SUCCESS [ 20.222 s]\n[INFO] rocketmq-store 5.0.0 ............................... SUCCESS [ 25.022 s]\n[INFO] rocketmq-srvutil 5.0.0 ............................. SUCCESS [  5.398 s]\n[INFO] rocketmq-filter 5.0.0 .............................. SUCCESS [  3.935 s]\n[INFO] rocketmq-acl 5.0.0 ................................. SUCCESS [ 15.476 s]\n[INFO] rocketmq-broker 5.0.0 .............................. SUCCESS [ 46.552 s]\n[INFO] rocketmq-tools 5.0.0 ............................... SUCCESS [ 10.486 s]\n[INFO] rocketmq-controller 5.0.0 .......................... SUCCESS [  5.169 s]\n[INFO] rocketmq-namesrv 5.0.0 ............................. SUCCESS [ 12.627 s]\n[INFO] rocketmq-proxy 5.0.0 ............................... SUCCESS [ 33.403 s]\n[INFO] rocketmq-container 5.0.0 ........................... SUCCESS [  4.208 s]\n[INFO] rocketmq-test 5.0.0 ................................ SUCCESS [ 19.495 s]\n[INFO] rocketmq-openmessaging 5.0.0 ....................... SUCCESS [  5.015 s]\n[INFO] rocketmq-example 5.0.0 ............................. SUCCESS [ 28.397 s]\n[INFO] rocketmq-distribution 5.0.0 ........................ SUCCESS [04:38 min]\n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD SUCCESS\n[INFO] ------------------------------------------------------------------------\n[INFO] Total time:  11:58 min\n[INFO] Finished at: 2023-01-26T17:21:57+08:00\n```\nredirect to rocketmq folder\n``` bash\ncd /opt/rocketmq-rocketmq-all-5.0.0/distribution/target/rocketmq-5.0.0/rocketmq-5.0.0\n``` \n\n##### START NAMESERVER\n``` bash\n> nohup sh bin/mqnamesrv & tail -f ~/logs/rocketmqlogs/namesrv.log\n> tail -f nohup.out\n### nohup.out shown sucessfully start name server.\nThe Name Server boot success. serializeType=JSON\n```\n##### START Broker\n``` bash\n> nohup sh bin/mqbroker -n localhost:9876 --enable-proxy & tail -f ~/logs/rocketmqlogs/broker_default.log\n> tail -f nohup.out\n### nohup.out shown sucessfully start broker.\nThe broker[LAPTOP-F7AOJL27, 172.20.32.00:10911] boot success. serializeType=JSON\n```\n\n\n##### TO STOP NAMESERVER AND BROKER\n``` bash\n>  sh bin/mqshutdown broker\n### shown shutdown successfully\nThe mqbroker(16375) is running...\nSend shutdown request to mqbroker(16375) OK\n\n> sh bin/mqshutdown namesrv\n### shown shutdown successfully \nThe mqnamesrv(15818) is running...\nSend shutdown request to mqnamesrv(15818) OK\n```\n\n\n##### Allow PORT TO ACCESS IN WINDOWS \n``` bash\n>  sudo nano /etc/wsl.conf\n\nadd the following lines to file:\n[network]\ngenerateHosts = true\ngenerateResolvConf = true\n\nVerify that the ports are open by running the following command on the Windows host:\n> netstat -an | find \"9876\"\n```\n\n\n##### Permission Issue - grant permission\ncase 1 : failed to compile the package\n``` bash\nsudo chown -R $USER:$USER /opt/rocketmq-rocketmq-all-5.0.0/target/\n```\n\n\n##### additional checking file existent \n``` bash\nls -l /opt/rocketmq-rocketmq-all-5.0.0/distribution/target/rocketmq-5.0.0/rocketmq-5.0.0/bin/runserver.sh\nls -l /opt/rocketmq-rocketmq-all-5.0.0/distribution/target/rocketmq-5.0.0/rocketmq-5.0.0/bin/mqbroker\n```","tags":["RocketMQ","WSL"],"categories":["MQ"]},{"title":"Select Sharding's table with conditional and pagination","path":"/2023/01/26/apache-sharding/","content":"Issue that I have encounter.1. Must have sharding column with subquery.Select subquery must include the \"sharding-column\" which have defined on the sharding's properties file.``` bashtables: table_a: actual-data-nodes: primary.table_a$->{11..12} # , primary.table_a$->{2021..2022}0$->{1..9}, primary.table_a$->{2021..2022}$->{10..12} table-strategy: standard: sharding-column: create_time # 分片键 precise-algorithm-class-name: com.acs.common.sharding.rule.table.TableMonthShardingAlgorithm  # 精确匹配的分片算法实现类 range-algorithm-class-name: com.acs.common.sharding.rule.table.TableMonthRangeShardingAlgorithm # 范围匹配的分片算法实现类 key-generator: column: id #type: custom_snowflake_keygen # 雪花算法生成主键 type: SNOWFLAKE props: worker: id: ${operator.worker} # 配置雪花算法的worker```if dont include the sharding-column in the query, there error will popout as following``` bashMust have sharding column with subquery.```--------------------------------------------------------------------------------------2. Select time range does not match any sharding tables.``` bash if (CollectionUtils.isEmpty(matchedTables)) { logger.warn(\"查询时间不在分表范围，路由到202006分表。beginDate = {} ，endDate = {}\", beginDate, endDate); // 没有匹配到任何表，直接默认路由到最早的一张表 matchedTables.add(logicTableName + \"_\" + CommonConstants.FIRST_SHARDING_TABLE_SUFFIX); }``` To resolve - add corresponding tables with monthdate in sharding's properties file as below``` bash actual-data-nodes: primary.table_a$->{11..12} # , primary.table_a$->{2021..2022}0$->{1..9}, primary.table_a$->{2021..2022}$->{10..12}``` --------------------------------------------------------------------------------------3. System error when select query beginDate and endTime in more than 1 monthobservation 1: select query with beginTime from 2022-12-01 00:00:00 to 2022-12-31 23:59:59, it can successfully retrieve the data without issue. observation 2: select query with beginTime from 2022-12-01 00:00:00 to 2023-02-28 23:59:59, cannot retrieve the result and show error with \"Must have sharding column with subquery.\"founding:pagination and sharding is conflict.solution:Have to add a additional mapper with same name as getListing query with countSuffix and the returnType should be Long. Eg:  id=\"memberReportListing_COUNT\"  resultType=\"long\"explaination:if didnt define the custom COUNT select query, the pagination inceptor with generate the select query by default.In this way to define the COUNT select query, it can be override the existing COUNT select query. so, that can easily for us to customize the query like the select and the where conditions as the listing query.``` bash <select id=\"selectMemberList_COUNT\" parameterType=\"com.test.business.dto.member.QueryDTO\" resultType=\"long\"> select count(distinct a.username) to eliminate duplicate from table_a  a LEFT JOIN table_b b on a.member_id = b.id JOIN table_c c on b.inviter_id = c.id <where> <if test='username  != null and username != \"\"'> and a.username = #{username} </if> <if test='realname  != null and realname != \"\"'> and b.real_name = #{realname} </if> <if test='layerId  != null and layerId != \"\"'> and a.layer_id = #{layerId} </if> <if test=\"beginTime != null and endTime != null\"> and a.create_time between #{beginTime} and #{endTime} </if> and a.status = 2 </where> </select> <select id=\"selectMemberList\" parameterType=\"com.test.business.dto.member.QueryDTO\" resultType=\"ccom.test.business.VO.member.memberVO\"> SELECT b.username AS username, b.real_name AS realname, b.phone AS phone, b.invite_code AS inviteCode, c.username AS inviterUsername, a.create_time  AS createTime FROM table_a a LEFT JOIN table_b b on a.member_id = b.id JOIN table_c c on b.inviter_id = c.id <where> <if test='username  != null and username != \"\"'> and a.username = #{username} </if> <if test='realname  != null and realname != \"\"'> and b.real_name = #{realname} </if> <if test='layerId  != null and layerId != \"\"'> and a.layer_id = #{layerId} </if> <if test=\"beginTime != null and endTime != null\"> and a.create_time between #{beginTime} and #{endTime} </if> and a.status = 2 </where> GROUP BY b.username </select>``` --------------------------------------------------------------------------------------4. total in pagination params is not tellyapproach:``` bashselect count(distinct a.username)make sure to have these in the select column to eliminate the duplicate ```","tags":["Apache Sharding Sphere","MyBatis 2"],"categories":["Sharding"]},{"title":"Hexo Basic Use","path":"/2023/01/26/hexo/","content":"create new layout ``` bashhexo new [layout] [title]```layout1. post \tsource/_posts2. page \tsource3. draft \tsource/_drafts Deploymenthexo generate --deploy","tags":["Hexo"],"categories":["Hexo"]},{"title":"Docker Installation","path":"/2023/01/26/docker/","content":"### Installation requirement\n\n\n---------------------------------------------------------------------------\n#### Command to operate Docker\nCannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?\n```\nsudo service docker status \nsudo service docker start\nsudo service docker stop\n```","tags":["Docker","WSL2"],"categories":["Docker"]},{"title":"Mqbroker cannot start. No Mqbroker is running.","path":"/2022/11/24/rocketmq/","content":"##### Observation:\n###### rocketMq log Path: log/rocketmqlogs/\n---\n#### broker.log\n``` bash\n2022-11-23 17:37:50 INFO main - load /root/store/config/subscriptionGroup.json OK\n2022-11-23 17:37:50 INFO main - load /root/store/config/consumerFilter.json OK\n2022-11-23 17:37:50 INFO main - Try to start service thread:AllocateMappedFileService started:false lastThread:null\n2022-11-23 17:37:50 INFO main - Try to shutdown service thread:AllocateMappedFileService started:true lastThread:Thread[AllocateMappedFileService,5,main]\n2022-11-23 17:37:50 INFO main - shutdown thread AllocateMappedFileService interrupt true\n2022-11-23 17:37:50 INFO main - join thread AllocateMappedFileService elapsed time(ms) 1 90000\n2022-11-23 17:37:50 INFO main - Try to shutdown service thread:PullRequestHoldService started:false lastThread:null\n```\n#### broker_default.log\n``` bash\n2022-11-15 14:38:55 WARN main - Unknown channel option 'SO_KEEPALIVE' for channel '[id: 0xb9a74f62]'\n2022-11-15 14:38:55 WARN main - Unknown channel option 'SO_KEEPALIVE' for channel '[id: 0x58284471]'\n2022-11-23 17:06:23 INFO main - instrumented a special java.util.Set into: sun.nio.ch.EPollSelectorImpl@4f6ee6e4\n2022-11-23 17:33:13 INFO main - instrumented a special java.util.Set into: sun.nio.ch.EPollSelectorImpl@327514f\n2022-11-23 17:37:50 INFO main - instrumented a special java.util.Set into: sun.nio.ch.EPollSelectorImpl@327514f\n2022-11-23 19:10:24 INFO main - instrumented a special java.util.Set into: sun.nio.ch.EPollSelectorImpl@4f6ee6e4\n2022-11-23 19:11:07 INFO main - instrumented a special java.util.Set into: sun.nio.ch.EPollSelectorImpl@4f6ee6e4\n2022-11-23 19:12:45 INFO main - instrumented a special java.util.Set into: sun.nio.ch.EPollSelectorImpl@4f6ee6e4\n2022-11-23 19:13:25 INFO main - instrumented a special java.util.Set into: sun.nio.ch.EPollSelectorImpl@4f6ee6e4\n2022-11-23 19:15:46 INFO main - instrumented a special java.util.Set into: sun.nio.ch.EPollSelectorImpl@4f6ee6e4\n2022-11-23 19:23:34 INFO main - instrumented a special java.util.Set into: sun.nio.ch.EPollSelectorImpl@4f6ee6e4\n2022-11-23 19:39:07 INFO main - instrumented a special java.util.Set into: sun.nio.ch.EPollSelectorImpl@4f6ee6e4\n2022-11-24 10:03:14 INFO main - instrumented a special java.util.Set into: sun.nio.ch.EPollSelectorImpl@4f6ee6e4\n2022-11-24 10:03:14 INFO main - instrumented a special java.util.Set into: sun.nio.ch.EPollSelectorImpl@15de0b3c\n2022-11-24 10:03:14 INFO main - instrumented a special java.util.Set into: sun.nio.ch.EPollSelectorImpl@3c9754d8\n2022-11-24 10:03:14 INFO main - instrumented a special java.util.Set into: sun.nio.ch.EPollSelectorImpl@3bf7ca37\n2022-11-24 10:03:14 INFO main - instrumented a special java.util.Set into: sun.nio.ch.EPollSelectorImpl@79079097\n2022-11-24 10:03:15 INFO main - instrumented a special java.util.Set into: sun.nio.ch.EPollSelectorImpl@85e6769\n2022-11-24 10:03:15 INFO main - instrumented a special java.util.Set into: sun.nio.ch.EPollSelectorImpl@48a12036\n2022-11-24 10:03:15 INFO main - instrumented a special java.util.Set into: sun.nio.ch.EPollSelectorImpl@bf1ec20\n2022-11-24 10:03:15 INFO main - instrumented a special java.util.Set into: sun.nio.ch.EPollSelectorImpl@70efb718\n2022-11-24 10:03:16 INFO main - Looking for a resource file of name [META-INF/service/org.apache.rocketmq.remoting.RPCHook] ...\n2022-11-24 10:03:16 WARN main - No resource file with name [META-INF/service/org.apache.rocketmq.remoting.RPCHook] found.\n```\n#### store.log\n``` bash\n2022-11-23 19:39:07 INFO main - load consume queue OFFSET_MOVED_EVENT-0 OK\n2022-11-23 19:39:07 INFO main - load logics queue all over, OK\n2022-11-23 19:39:07 INFO main - store checkpoint file exists, /root/store/checkpoint\n2022-11-23 19:39:07 INFO main - store checkpoint file physicMsgTimestamp 1669191612663, 20221123082012663\n2022-11-23 19:39:07 INFO main - store checkpoint file logicsMsgTimestamp 1669191612663, 20221123082012663\n2022-11-23 19:39:07 INFO main - store checkpoint file indexMsgTimestamp 0, 19700101000000000\n2022-11-23 19:39:07 ERROR main - load exception\njava.lang.IllegalStateException: java.lang.reflect.InaccessibleObjectException: Unable to make public java.lang.Object java.nio.DirectByteBuffer.attachment() accessible: module java.base does not \"opens java.nio\" to unnamed module @7be0cc22\n\tat org.apache.rocketmq.store.MappedFile$1.run(MappedFile.java:105)\n\tat java.base/java.security.AccessController.doPrivileged(AccessController.java:318)\n\tat org.apache.rocketmq.store.MappedFile.invoke(MappedFile.java:98)\n\tat org.apache.rocketmq.store.MappedFile.viewed(MappedFile.java:130)\n\tat org.apache.rocketmq.store.MappedFile.clean(MappedFile.java:94)\n\tat org.apache.rocketmq.store.MappedFile.cleanup(MappedFile.java:439)\n\tat org.apache.rocketmq.store.ReferenceResource.release(ReferenceResource.java:63)\n\tat org.apache.rocketmq.store.ReferenceResource.shutdown(ReferenceResource.java:47)\n\tat org.apache.rocketmq.store.MappedFile.destroy(MappedFile.java:447)\n\tat org.apache.rocketmq.store.index.IndexFile.destroy(IndexFile.java:89)\n\tat org.apache.rocketmq.store.index.IndexService.load(IndexService.java:71)\n\tat org.apache.rocketmq.store.DefaultMessageStore.load(DefaultMessageStore.java:209)\n\tat org.apache.rocketmq.broker.BrokerController.initialize(BrokerController.java:270)\n\tat org.apache.rocketmq.broker.BrokerStartup.createBrokerController(BrokerStartup.java:220)\n\tat org.apache.rocketmq.broker.BrokerStartup.main(BrokerStartup.java:57)\nCaused by: java.lang.reflect.InaccessibleObjectException: Unable to make public java.lang.Object java.nio.DirectByteBuffer.attachment() accessible: module java.base does not \"opens java.nio\" to unnamed module @7be0cc22\n\tat java.base/java.lang.reflect.AccessibleObject.checkCanSetAccessible(AccessibleObject.java:354)\n\tat java.base/java.lang.reflect.AccessibleObject.checkCanSetAccessible(AccessibleObject.java:297)\n\tat java.base/java.lang.reflect.Method.checkCanSetAccessible(Method.java:199)\n\tat java.base/java.lang.reflect.Method.setAccessible(Method.java:193)\n\tat org.apache.rocketmq.store.MappedFile$1.run(MappedFile.java:102)\n\t... 14 common frames omitted\n2022-11-23 19:39:07 WARN AllocateMappedFileService - AllocateMappedFileService interrupted, possibly by shutdown.\n2022-11-23 19:39:07 INFO AllocateMappedFileService - AllocateMappedFileService service end\n```\n---\n\n### Solution\n1. delete abort file in the root/store folder\n    - start the mqbroker again\n    - if issue still persist , use step 2.\n2. delete root/store folder\n   - restart rocketmq again , it will auto regenerate store folder. \n   - start the mqbroker again.\n   - if issue still persist, proceed to step 3.\n3. delete root/store folder, restart the server - sudo restart\n   - start namesrv again \n   - start mqbroker again","tags":["RocketMQ"],"categories":["MQ"]},{"title":"Hello World","path":"/2022/11/24/hello-world/","content":"Welcome to [Hexo](https://hexo.io/)! This is your very first post. Check [documentation](https://hexo.io/docs/) for more info. If you get any problems when using Hexo, you can find the answer in [troubleshooting](https://hexo.io/docs/troubleshooting.html) or you can ask me on [GitHub](https://github.com/hexojs/hexo/issues).\n\n## Quick Start\n\n### Create a new post\n\n``` bash\n$ hexo new \"My New Post\"\n```\n\nMore info: [Writing](https://hexo.io/docs/writing.html)\n\n### Run server\n\n``` bash\n$ hexo server\n```\n\nMore info: [Server](https://hexo.io/docs/server.html)\n\n### Generate static files\n\n``` bash\n$ hexo generate\n```\n\nMore info: [Generating](https://hexo.io/docs/generating.html)\n\n### Deploy to remote sites\n\n``` bash\n$ hexo deploy\n```\n\nMore info: [Deployment](https://hexo.io/docs/one-command-deployment.html)"}]